name: CI/CD con Seguridad - My-Ecommerce ITESO

on:
  push:                                       
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Instalar dependencias
        run: npm ci
      
      - name: Compilar
        run: npm run build

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Instalar dependencias
        run: npm ci
      
      - name: Ejecutar pruebas
        run: npm run test:coverage
        env:
          NODE_ENV: test
          JWT_SECRET: test_secret_key_for_unit_tests
          MONGO_URI: ${{ secrets.MONGO_URI }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_CALLBACK_URL: ${{ secrets.GOOGLE_CALLBACK_URL }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
        if: always()

  sca:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Ejecutar Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
        continue-on-error: true
      
      - uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-results.json
        if: always()

  secret_scanning:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - run: docker run --rm -v $(pwd):/src trufflesecurity/trufflehog:latest filesystem /src --json --no-update > trufflehog-output.json || true
        continue-on-error: true
      
      - uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-output.json
        if: always()

  sast:
    runs-on: ubuntu-latest
    needs: [sca, secret_scanning]
    steps:
      - uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Instalar dependencias
        run: npm ci
      
      - name: Ejecutar ESLint
        run: npx eslint src --ext .ts --format json --output-file eslint-report.json || true
        continue-on-error: true
      
      - uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
        if: always()
        
  zap_baseline:
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4
      
      - name: ZAP scan (simulado)
        run: echo "ZAP scan requiere servidor corriendo. Ver documentación para implementación completa."
      
      - name: Crear reporte placeholder
        run: echo '{"status":"skipped","reason":"requires running server"}' > zap-output.json
      
      - uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-output.json
        if: always()

  prod:
    runs-on: ubuntu-latest
    needs: zap_baseline
    steps:
      - run: echo "Pipeline completado. Revisar artifacts para reportes de seguridad."